<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service History — Senior</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="../css/styles.css" />

  <!-- Optional: pager styling (if you prefer, move to styles.css) -->
  <style>
    .history-pager{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding:12px 0;
      flex-wrap: wrap;
    }
    .history-pager .pager-info{
      margin:0 8px;
      font-size:0.9rem;
      color:var(--muted, #666);
    }
    .history-pager .pager-btn.active{
      background: var(--brand, #E6993B);
      color:#fff;
    }
  </style>
</head>

<body>

  <header>
    <nav class="nav" aria-label="Primary">
      <div class="first-line">
        <div class="logo">
          <div class="logo2">
            <a href="../index.html">
              <img src="../assets/img/logo.png" alt="logo" />
            </a>
            <a href="../index.html">
              <span>BuddyLink</span>
            </a>
          </div>

          <div id="forservice">
            <a href="askforservice.html" aria-label="ask for services" data-i18n="askforservice2lines">Ask for<br>Services</a>
          </div>
        </div>
      </div>

      <div class="menu">
        <nav class="sub-menu">
          <a href="../index.html" aria-label="Back to Home" data-i18n="backtohome">Home</a>

          <a class="btn" id="ctaJoin" href="pages/login.html" role="button">
            <i class="fas fa-hands-helping"></i>
            <span data-i18n="login">Login</span>
          </a>
        </nav>

        <label class="lang" aria-label="Language switcher">
          <i class="fas fa-globe"></i>
          <select id="langSelect" aria-label="Language">
            <option value="en">English</option>
            <option value="fr">Français</option>
          </select>
        </label>
      </div>
    </nav>
  </header>    


  <main class="container">
    <section class="card p-6 my-8" aria-labelledby="history-title">
      <div class="history-header">
        <div>
          <h1 id="history-title" style="margin:0;" data-i18n="servicehistory">
            Service History
          </h1>
          <div id="history-sub" class="history-meta">
            Loading...
          </div>
        </div>
        <button id="btn-refresh" class="btn"  data-i18n="refresh" style="display:none;">
          Refresh
        </button>
      </div>

      <div id="history-state" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        Fetching records... 
      </div>

      <div id="history-list" class="history-list" hidden></div>

      <!-- NEW: pager -->
      <div id="history-pager" class="history-pager" hidden></div>
    </section>
  </main>

<footer>
    <p>&copy; 2025</p>
</footer>


  <!-- your global app.js (i18n, navbar state, etc.) -->
  <script type="module" src="../js/app.js"></script>

  <script type="module">
    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (sel) => document.querySelector(sel);
    const volunteerCache = new Map(); // prevent undefined error

    function fmtDate(isoStr) {
      if (!isoStr) return "Unknown date";
      const d = new Date(isoStr);
      if (Number.isNaN(d.getTime())) return isoStr;
      return d.toLocaleString();
    }

    function starsHTML(rating) {
      let r = Number(rating);
      if (!Number.isFinite(r)) r = 0;
      r = Math.max(0, Math.min(5, r));
      const full = Math.floor(r);
      const half = (r - full >= 0.5) ? 1 : 0;
      const empty = 5 - full - half;

      let html = `<span class="stars" aria-label="rating ${r}">`;
      for (let i = 0; i < full; i++) html += `<i class="fas fa-star"></i>`;
      if (half) html += `<i class="fas fa-star-half-alt"></i>`;
      for (let i = 0; i < empty; i++) html += `<i class="far fa-star"></i>`;
      html += `</span>`;
      return html;
    }

    function arrBadges(arr) {
      if (!Array.isArray(arr) || arr.length === 0) return "";
      return arr.map(x => `<span class="badge">${x}</span>`).join("");
    }

    // -----------------------------
    // Pagination config/state
    // -----------------------------
    const LIMIT = 20;
    let currentPage = 1;
    let totalPages = 1;

    // -----------------------------
    // Fetch with page/limit
    // -----------------------------
    async function fetchServicesForCurrentSenior(page = 1, limit = LIMIT) {
      const res = await fetch(`/api/senior/services?page=${page}&limit=${limit}`, {
        credentials: "include"
      });
      const json = await res.json().catch(()=> ({}));

      if (!res.ok || !json.success) {
        throw new Error(json.message || "Failed to fetch services");
      }
      return json; // contains services, total, page, limit, maybe total_pages
    }

    async function fetchVolunteer(volunteerId, embeddedInfo=null) {
      if (embeddedInfo && Object.keys(embeddedInfo).length > 0) {
        return embeddedInfo;
      }
      if (!volunteerId) return {};

      const key = String(volunteerId);
      if (volunteerCache.has(key)) return volunteerCache.get(key);

      // You can expand later to actually fetch volunteer by id if needed
      volunteerCache.set(key, {});
      return {};
    }

    // -----------------------------
    // Stars editor (clickable)
    // -----------------------------
    function starsEditor(serviceId, rating) {
      let r = Number(rating);
      if (!Number.isFinite(r)) r = 0;
      r = Math.max(0, Math.min(5, r));
      const full = Math.floor(r);
      const half = (r - full >= 0.5) ? 1 : 0;

      let html = `<span class="stars editable" data-service-id="${serviceId}" data-current="${r}">`;
      for (let i = 1; i <= 5; i++) {
        let iconClass = "far fa-star";
        if (i <= full) iconClass = "fas fa-star";
        else if (i === full + 1 && half) iconClass = "fas fa-star-half-alt";

        html += `
          <i class="${iconClass} star-btn"
             data-value="${i}"
             role="button"
             tabindex="0"
             aria-label="rate ${i} stars"></i>
        `;
      }
      html += `</span>`;
      return html;
    }

    function updateStarsUI(wrapper, rating) {
      const icons = wrapper.querySelectorAll(".star-btn");
      icons.forEach(icon => {
        const val = Number(icon.dataset.value);
        icon.classList.remove("fas", "far", "fa-star", "fa-star-half-alt");
        if (val <= rating) icon.classList.add("fas", "fa-star");
        else icon.classList.add("far", "fa-star");
      });
    }

    // click to rate
    $("#history-list").addEventListener("click", async (e) => {
      const star = e.target.closest(".star-btn");
      if (!star) return;

      const wrapper = star.closest(".stars.editable");
      if (!wrapper) return;

      const serviceId = wrapper.dataset.serviceId;
      const newRating = Number(star.dataset.value);
      if (!serviceId || !Number.isFinite(newRating)) return;

      const oldRating = Number(wrapper.dataset.current || 0);
      wrapper.dataset.current = newRating;
      updateStarsUI(wrapper, newRating);

      try {
        const res = await fetch(`/api/services/${serviceId}/rating`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ rating: newRating })
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok || json.success === false) {
          throw new Error(json.message || "Update failed");
        }
      } catch (err) {
        console.error(err);
        wrapper.dataset.current = oldRating;
        updateStarsUI(wrapper, oldRating);
        alert("Failed to update rating");
      }
    });

    // keyboard rate
    $("#history-list").addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const star = e.target.closest(".star-btn");
      if (!star) return;
      e.preventDefault();
      star.click();
    });

    // -----------------------------
    // Render state/list
    // -----------------------------
    function setState(type, msg) {
      const st = $("#history-state");
      const list = $("#history-list");
      const pager = $("#history-pager");

      list.hidden = true;
      pager.hidden = true;

      st.hidden = false;
      st.className = type;
      st.innerHTML = msg;
    }

    function renderList(records) {
      const list = $("#history-list");
      const st = $("#history-state");

      st.hidden = true;
      list.hidden = false;
      list.innerHTML = records.map(r => r.__html).join("");
    }

    // -----------------------------
    // Pager render + events
    // -----------------------------
    function renderPager(page, totalPages) {
  const pager = $("#history-pager");
  if (totalPages <= 1) {
    pager.hidden = true;
    pager.innerHTML = "";
    return;
  }

  pager.hidden = false;

  const windowSize = 5;
  let start = Math.max(1, page - Math.floor(windowSize / 2));
  let end = Math.min(totalPages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  let html = `
    <a href="#" class="pager-link prev ${page <= 1 ? "disabled" : ""}" data-page="${page - 1}">
      ◀ Prev
    </a>
    <span class="pager-info">Page ${page} / ${totalPages}</span>
  `;

  for (let p = start; p <= end; p++) {
    html += `&nbsp;
      <a href="#"
         class="pager-link ${p === page ? "active" : ""}"
         data-page="${p}">
        ${p}
      </a>&nbsp;&nbsp;
    `;
  }

  html += `
    <a href="#" class="pager-link next ${page >= totalPages ? "disabled" : ""}" data-page="${page + 1}">
      Next ▶
    </a>
  `;

  pager.innerHTML = html;
}


$("#history-pager").addEventListener("click", (e) => {
  const link = e.target.closest(".pager-link");
  if (!link) return;

  e.preventDefault(); // stop page jump

  if (link.classList.contains("disabled")) return;

  const p = Number(link.dataset.page);
  if (!Number.isFinite(p) || p < 1 || p > totalPages) return;

  currentPage = p;
  loadHistory(currentPage);
});


    // -----------------------------
    // Load history (hard pagination)
    // -----------------------------
    async function loadHistory(page = 1) {
      try {
        setState("loading",
          `<i class="fas fa-spinner fa-spin"></i> Fetching records... `
        );

        const payload = await fetchServicesForCurrentSenior(page, LIMIT);
        const services = payload.services || [];
        const total = payload.total ?? services.length;

        totalPages = payload.total_pages ?? Math.max(1, Math.ceil(total / LIMIT));
        currentPage = payload.page ?? page;

        $("#history-sub").innerHTML =
          `<span data-i18n="records">Records</span> <span>: ${total} </span><span  data-i18n="totalpage">total / page </span><span>${currentPage} </span>`;

        if (services.length === 0) {
          setState("empty", `No service records yet.`);
          renderPager(currentPage, totalPages);
          return;
        }

        services.sort((a,b)=>{
          const ta = new Date(a.serve_at || 0).getTime();
          const tb = new Date(b.serve_at || 0).getTime();
          return tb - ta;
        });

        const hydrated = await Promise.all(services.map(async s => {
          const v = await fetchVolunteer(s.volunteer, s.volunteer_info);

          const name = [v.firstname, v.lastname].filter(Boolean).join(" ")
            || "Unknown volunteer ";
          const city = v.city ? `${v.city}` : "";
          const langs = arrBadges(v.language);
          const skills = arrBadges(v.skills);

          const avatar = v.photo_url || "../assets/img/unknown.jpg";
          const when = fmtDate(s.serve_at);
          const rating = starsEditor(s._id, s.rating);

          const html = `
            <div class="card p-4 hover history-item">
              <div class="history-left">
                <img class="vol-avatar" src="${avatar}" alt=""/>
                <div class="service-item">
                  <div style="font-weight:600; font-size:1.05rem;">${name}</div>

                  <div class="small" style="margin-top:6px;">
                    <strong data-i18n="city">City</strong><strong>:&nbsp;</strong>
                    ${city}
                  </div>

                  <div class="small" style="margin-top:6px;">
                    <strong data-i18n="servetime">Serve time</strong><strong>:&nbsp;</strong>
                    ${when}
                  </div>

                  <div class="small" style="margin-top:6px;">
                    <strong data-i18n="language">Languages</strong><strong>:&nbsp;</strong>
                    ${langs || `<span class="muted">N/A</span>`}
                  </div>

                  <div class="small" style="margin-top:6px;">
                    <strong data-i18n="pdservice">Providing Service</strong><strong>:&nbsp;</strong>
                    ${skills || `<span class="muted">N/A</span>`}
                  </div>
                </div>
              </div>

              <div style="text-align:right;">
                <div class="small muted" data-i18n="rating">Rating</div>
                <div>${rating}</div>
              </div>
            </div>
          `;

          return { ...s, __html: html };
        }));

        renderList(hydrated);
        renderPager(currentPage, totalPages);

      } catch (err) {
        console.error(err);
        setState("error",
          `<div style="color:#b00020;">
            Failed to load history: ${err.message}
            <br/>Error: ${err.message}
          </div>`
        );
        $("#history-sub").textContent = "Error";
        renderPager(1, 1);
      }
    }

    $("#btn-refresh").addEventListener("click", () => loadHistory(currentPage));
    document.addEventListener("DOMContentLoaded", () => loadHistory(1));
  </script>

</body>
</html>
