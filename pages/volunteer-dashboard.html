<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard â€” Volunteer</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="../css/styles.css" />
</head>
<body>
<header>
  <nav class="nav" aria-label="Primary">
    <div class="first-line">
      <div class="logo">
        <div class="logo2">
          <a href="../index.html">
            <img src="../assets/img/logo.png" alt="logo" />
          </a>
          <a href="../index.html">
            <span>BuddyLink</span>
          </a>
        </div>
      </div>
      <img id="avatar-id"
           style="width:36px;height:36px;border-radius:50%;object-fit:cover;cursor:pointer;">
    </div>

    <div class="menu">
      <nav class="sub-menu">

        <a href="volunteer-profile.html" aria-label="My profile" data-i18n="navProfile">My profile</a>
        <a href="../index.html" aria-label="Back to Home" data-i18n="backtohome">Home</a>
        <a class="btn" id="ctaJoin" href="pages/login.html" role="button">
          <i class="fas fa-hands-helping"></i>
          <span data-i18n="login">Login</span>
        </a>
      </nav>



      <label class="lang" aria-label="Language switcher">
        <i class="fas fa-globe"></i>
        <select id="langSelect" aria-label="Language">
          <option value="en">English</option>
          <option value="fr">FranÃ§ais</option>
        </select>
      </label>
    </div>
  </nav>
</header>

<main class="container">
  <!-- é¡¶éƒ¨ Dashboard å¡ç‰‡ -->
  <section class="card p-6 my-8" aria-labelledby="dash-title">
    <div class="wrap dash-hero">
      <!-- photo -->
      <div class="dash-avatar-block">
        <img
          id="dash-avatar"
          src="../assets/img/avatar-placeholder.png"
          alt="Volunteer avatar"
          style="width:110px;height:110px;border-radius:50%;object-fit:cover;border:2px solid #ddd;"
        />
      </div>

      <!-- welcome+basic info -->
      <div class="dash-info-block">
        <h1 id="dash-title">
          <span data-i18n="dashWelcome">Welcome back,</span>
          <span id="dash-name">Volunteer</span> ðŸ‘‹
        </h1>
        <p class="lead">
          <span id="dash-email" class="muted"></span>
        </p>
        <p class="muted" data-i18n="dashSub">
          Thank you for supporting seniors in your community.
        </p>
      </div>
    </div>

    <!-- quick action -->
    <div class="wrap" style="margin-top:2rem;">
      <h2 class="section-sub" data-i18n="dashQuickActions">Quick actions</h2>
      <div class="row cols-2">
        <a class="card p-4 hover" href="volunteer-profile.html">
          <h3 data-i18n="dashEditProfile">Edit my profile</h3>
          <p data-i18n="dashEditProfileSub">
            Update your contact info, services you can provide, and availability.
          </p>
        </a>
        <a class="card p-4 hover" href="askforservice.html">
          <h3 data-i18n="dashViewRequests">View senior requests</h3>
          <p data-i18n="dashViewRequestsSub">
            In the full app, this will show seniors in your area needing support.
          </p>
        </a>
      </div>
    </div>
  </section>

  <!-- Pending requests for this volunteer -->
  <section id="section-requests" class="card p-6 my-8">
    <div class="wrap">
      <h2 class="section-sub">Requests waiting for your response</h2>
      <p id="request-empty" class="muted">Loadingâ€¦</p>
    <div id="request-list"></div>
  </div>
</section>

  <!-- Upcoming accepted services -->
  <section class="card p-6 my-8">
    <div class="wrap">
      <h2 class="section-sub">Your upcoming services</h2>
      <p id="upcoming-empty" class="muted">Loadingâ€¦</p>
    <div id="upcoming-list"></div>
  </div>
  </section>

<footer class="container py-8">
  <p>&copy; 2025 BuddyLink</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module" src="../js/app.js"></script>

<script type="module">
    // from /api/volunteer/profile get first + last + email + photo
  /* -----------------------------------------------------------
     Load Volunteer Dashboard Info
  ------------------------------------------------------------*/
  async function loadVolunteerDashboard() {
    try {
      const res = await fetch("/api/volunteer/profile", {
        credentials: "include"
      });

      if (res.status === 401 || res.status === 403) {
        console.warn("Not logged in or not a volunteer.");
        return;
      }

      const json = await res.json();
      if (!json.success) {
        console.warn("profile success = false", json);
        return;
      }

      const v = json.data || {};

      // first + last
      const fullName = `${v.firstname || ""} ${v.lastname || ""}`.trim();
      document.getElementById("dash-name").textContent = fullName || "Volunteer";

      // email
      if (v.email) {
        document.getElementById("dash-email").textContent = v.email;
      }

      // photo
      if (v.photo_url) {
        document.getElementById("dash-avatar").src = v.photo_url;
      }
    } catch (err) {
      console.error("Failed to load dashboard info", err);
    }
  }

  /* -----------------------------------------------------------
     Load Volunteer Requests (Pending)
  ------------------------------------------------------------*/
  async function loadVolunteerRequests() {
    const listEl  = document.getElementById("request-list");
    const emptyEl = document.getElementById("request-empty");

    if (!listEl || !emptyEl) return;

    emptyEl.textContent = "Loadingâ€¦";
    emptyEl.hidden = false;
    listEl.innerHTML = "";

    try {
      const res = await fetch("/api/volunteer/requests", { credentials: "include" });
      const json = await res.json();

      if (!json.success) throw new Error(json.message || "Failed to load pending requests");

      const items = json.data || [];
      if (!items.length) {
        emptyEl.textContent = "No pending requests right now.";
        return;
      }

      emptyEl.hidden = true;

      listEl.innerHTML = items.map(r => {
        const ask  = Array.isArray(r.askfor) ? r.askfor.join(", ") : "";
        const time = Array.isArray(r.appointment) ? r.appointment.join(", ") : "";
        const notes = r.notes || "";

        return `
          <article class="card p-4 hover" data-request-id="${r.request_id}">
            <h3>${ask || "Support request"}</h3>
            <p><strong>Time:</strong> ${time || "Flexible"}</p>
            <p><strong>Notes:</strong> ${notes || "â€”"}</p>
            <div class="form-actions mt-2">
              <button class="btn btn-accept" type="button">Accept this request</button>
            </div>
          </article>
        `;
      }).join("");

    } catch (err) {
      console.error(err);
      emptyEl.textContent = "Failed to load requests.";
      listEl.innerHTML = "";
    }
  }

  /* -----------------------------------------------------------
     Load Upcoming Services
  ------------------------------------------------------------*/
  async function loadVolunteerUpcoming() {
    const listEl  = document.getElementById("upcoming-list");
    const emptyEl = document.getElementById("upcoming-empty");

    if (!listEl || !emptyEl) return;

    emptyEl.textContent = "Loadingâ€¦";
    emptyEl.hidden = false;
    listEl.innerHTML = "";

    try {
      const res = await fetch("/api/volunteer/upcoming", { credentials: "include" });
      const json = await res.json().catch(() => ({}));

      if (!res.ok || json.success === false) {
        throw new Error(json.message || "Failed to load upcoming services");
      }

      const items = json.data || [];
      if (!items.length) {
        emptyEl.textContent = "No upcoming services yet.";
        return;
      }

      emptyEl.hidden = true;

      listEl.innerHTML = items.map(r => {
        const req = r.requirements || {};
        const ask = Array.isArray(req.askfor) ? req.askfor.join(", ") : "";
        const time = Array.isArray(req.appointment) ? req.appointment.join(", ") : "";

        const s = r.senior_info || {};
        const name = (s.firstname && s.lastname)
          ? `${s.firstname} ${s.lastname}`
          : "Senior";

        const city  = s.city || "";
        const phone = s.phone || "N/A";

        return `
          <div class="card p-3" style="margin-bottom:1rem;">
            <div><strong>Service:</strong> ${ask || "Support"}</div>
            <div><strong>Time:</strong> ${time || r.booking_at || ""}</div>
            <div><strong>Senior:</strong> ${name}${city ? ` (${city})` : ""}</div>
            <div><strong>Phone:</strong> ${phone}</div>
            <div><strong>Booking at:</strong> ${r.booking_at || ""}</div>
          </div>
        `;
      }).join("");

    } catch (err) {
      console.error(err);
      emptyEl.textContent = "Failed to load upcoming services.";
    }
  }

  /* -----------------------------------------------------------
     Accept Request
  ------------------------------------------------------------*/
  async function acceptRequest(requestId, cardEl, btnEl) {
    try {
      btnEl.disabled = true;
      btnEl.textContent = "Acceptingâ€¦";

      const res = await fetch(`/api/requests/${requestId}/accept`, {
        method: "POST",
        credentials: "include"
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.success === false) {
        throw new Error(json.message || "Failed to accept this request");
      }

      // åŽç«¯ä¼šæ¨¡æ‹Ÿâ€œå‘é‚®ä»¶â€åˆ° console
      // å‰ç«¯è¿™è¾¹æ›´æ–°åˆ—è¡¨
      cardEl.remove();
      await loadVolunteerRequests();
      await loadVolunteerUpcoming();

      // ä¹Ÿå¯ä»¥åŠ ä¸€ä¸ªæç¤º
      Swal.fire({
        icon: "success",
        title: "Request accepted",
        text: "The senior will receive a notification email (simulated)."
      });

    } catch (err) {
      console.error(err);
      alert(err.message);
      btnEl.disabled = false;
      btnEl.textContent = "Accept this request";
    }
  }

  /* -----------------------------------------------------------
     EVENT: Accept Button Handler
  ------------------------------------------------------------*/
  document.addEventListener("click", e => {
    const btn = e.target.closest(".btn-accept");
    if (!btn) return;

    const card = btn.closest("[data-request-id]");
    if (!card) return;

    const requestId = card.dataset.requestId;
    if (!requestId) return;

    acceptRequest(requestId, card, btn);
  });

  /* -----------------------------------------------------------
     Init on Page Load
  ------------------------------------------------------------*/
  document.addEventListener("DOMContentLoaded", () => {
    loadVolunteerDashboard();
    loadVolunteerRequests();
    loadVolunteerUpcoming();
  });
</script>

</body>
</html>
